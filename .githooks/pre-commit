#!/bin/bash

# =======================================
# Optimized Kotlin Pre-commit Hook
# Checks & formats staged Kotlin files
# Supports optional Detekt analysis
# =======================================

set -e

echo "üîπ Kotlin pre-commit check starting..."

# Navigate to project root
ROOT_DIR=$(git rev-parse --show-toplevel)
cd "$ROOT_DIR" || exit 1

# Get staged Kotlin files (.kt and .kts)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.kt$|\.kts$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo "‚úÖ No staged Kotlin files. Skipping checks."
    exit 0
fi

NUM_FILES=$(echo "$STAGED_FILES" | wc -l)
echo "üîπ Found $NUM_FILES staged Kotlin file(s)."

# Create temporary file with staged files
TEMP_FILE_LIST=$(mktemp)
echo "$STAGED_FILES" > "$TEMP_FILE_LIST"

# Run Gradle ktlint tasks once
if ./gradlew tasks --all | grep -q "ktlint"; then
    echo "üõ† Running ktlint format + check on staged files..."
    ./gradlew ktlintFormat ktlintCheck -Pktlint.fileList="$TEMP_FILE_LIST" --quiet
else
    echo "‚ùå ktlint plugin not found. Add to Gradle:"
    echo 'plugins { id("org.jlleitschuh.gradle.ktlint") version "11.6.1" }'
    rm -f "$TEMP_FILE_LIST"
    exit 1
fi

# Re-add any reformatted files to staging
CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR | grep -E '\.kt$|\.kts$' || true)
if [ -n "$CHANGED_FILES" ]; then
    echo "‚ú® Reformatted files added to staging:"
    echo "$CHANGED_FILES"
    echo "$CHANGED_FILES" | xargs git add
fi

# Optional: run detekt if task exists
if ./gradlew tasks --all | grep -q "detekt"; then
    echo "üîç Running detekt analysis..."
    if ./gradlew detekt --quiet; then
        echo "‚úÖ Detekt passed"
    else
        echo "‚ùå Detekt found issues! Check reports in build/reports/detekt/"
        rm -f "$TEMP_FILE_LIST"
        exit 1
    fi
fi

rm -f "$TEMP_FILE_LIST"
echo "‚úÖ Kotlin pre-commit check finished successfully."
exit 0
