#!/bin/bash

# ktlint pre-commit hook
echo "Running ktlint formatting..."

# Get project root
ROOT_DIR=$(git rev-parse --show-toplevel)
cd "$ROOT_DIR" || exit 1

# Check if ktlint is available
if ! command -v ktlint &> /dev/null && ! ./gradlew ktlint --help &> /dev/null; then
    echo "Error: ktlint not found. Please install ktlint or add it to your Gradle project."
    exit 1
fi

# Get list of staged Kotlin files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.kt[s"]\?$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo "No staged Kotlin files found. Skipping ktlint formatting."
    exit 0
fi

echo "Formatting ${#STAGED_FILES[@]} Kotlin file(s)..."

# Format files
if command -v ktlint &> /dev/null; then
    echo "$STAGED_FILES" | xargs ktlint -F
else
    echo "$STAGED_FILES" | xargs ./gradlew ktlintFormat -q
fi

# Add formatted files back to staging
CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR | grep '\.kt[s"]\?$' || true)
if [ -n "$CHANGED_FILES" ]; then
    echo "The following files were reformatted:"
    echo "$CHANGED_FILES"
    echo "$CHANGED_FILES" | xargs git add
    echo "Reformatted files have been added to staging."
fi

echo "ktlint formatting completed!"
exit 0